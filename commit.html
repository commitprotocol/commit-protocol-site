<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="/menu.css">
<meta charset="UTF-8">
<title>Mint a Commit - Commit Protocol</title>
<meta name="description" content="Mint an immutable on-chain commit using Commit Protocol. Write ASCII messages and permanently record them on-chain. No edits. No deletes.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }

body {
  margin:0;
  font-family:'Inter', system-ui;
  background:#0d1117;
  color:#c9d1d9;
  display:flex;
  justify-content:center;
  padding:24px;
}

main {
  width:100%;
  display:flex;
  justify-content:center;
}

.card {
  width:100%;
  max-width:520px;
  background:#161b22;
  border-radius:22px;
  padding:28px;
  border:1px solid #30363d;
  box-shadow:0 0 60px rgba(0,0,0,.6);
  text-align:center;
}

.logo { width:72px; margin-bottom:14px; }

h1 { margin:0; font-size:22px; }

.subtitle {
  font-size:14px;
  opacity:.8;
  margin-bottom:18px;
  color:#8b949e;
}

textarea {
  width:100%;
  height:430px;
  padding:12px;
  border-radius:12px;
  border:1px solid #30363d;
  background:#0d1117;
  color:#c9d1d9;
  resize:vertical;
  font-family:JetBrains Mono, monospace;
  font-size:14px;
  line-height:20px;
  overflow:auto;
}

#lineInfo {
  font-size:13px;
  opacity:.7;
  margin-top:6px;
  text-align:right;
  color:#8b949e;
}

.card button {
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ccc;
  font-weight:700;
  margin-top:12px;
  cursor:pointer;
  background:#ffffff;
  color:#000;
}

.card button:disabled {
  opacity:.45;
  cursor:not-allowed;
}

#wallet {
  font-size:13px;
  opacity:.85;
  margin-top:10px;
  word-break:break-all;
  color:#8b949e;
}

#status {
  margin-top:14px;
  min-height:22px;
  font-size:14px;
  color:#8b949e;
}

#popup {
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#161b22;
  color:#fff;
  padding:16px 24px;
  border-radius:14px;
  border:1px solid #30363d;
  box-shadow:0 10px 40px rgba(0,0,0,.8);
  display:none;
  z-index:1000;
}

#popup.show { display:block; }

#popup button { margin-top:12px; }

button.loading {
  position: relative;
  pointer-events: none;
  opacity: 0.6;
}

button.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 18px;
  height: 18px;
  margin: -9px 0 0 -9px;
  border: 3px solid #000;
  border-top: 3px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<div id="global-menu"></div>

<main>
<article class="card">

<header>
  <img src="logo.png" class="logo" alt="Commit Protocol Logo">
  <h1>Commit Protocol</h1>
  <div class="subtitle">Mint an immutable on-chain commit (ASCII supported)</div>
</header>

<section>
  <textarea id="commitMessage" placeholder="21 lines · 49 chars per line · total 1049 chars"></textarea>
  <div id="lineInfo">
    Lines: <span id="lineCount">0</span> / 21 |
    Chars: <span id="charCount">0</span> / 1049
  </div>
</section>

<section>
  <div class="info">COMMIT_FEE: <strong><span id="commitFee">–</span> ETH</strong></div>
  <button id="connect">Connect Wallet</button>
  <button id="commit" disabled>Commit</button>
  <div id="wallet">Wallet not connected</div>
  <div id="status"></div>
</section>

<footer style="margin-top:18px;font-size:12px;opacity:.6;">
  commit-protocol://v0 — irreversible by design
</footer>

</article>
</main>

<div id="popup">
  <div id="popupMessage"></div>
  <button onclick="hidePopup()">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT_ADDRESS = "0x0b3D715D6EB9e5fd9Da666CB486710A45e8a6895"; 
const ABI = [
  "function commit(string calldata message) external payable returns(uint256)",
  "function COMMIT_FEE() view returns(uint256)"
];
const BASE_CHAIN_ID = "0x2105";
const MAX_LINES = 21;
const MAX_LINE_LENGTH = 49;
const MAX_CHARS = 1049;

let provider, signer, contract, currentAccount, currentChainId, commitFee;

const messageInput = document.getElementById("commitMessage");
const charCountEl = document.getElementById("charCount");
const lineCountEl = document.getElementById("lineCount");
const commitBtn = document.getElementById("commit");
const connectBtn = document.getElementById("connect");
const walletText = document.getElementById("wallet");
const statusEl = document.getElementById("status");
const feeEl = document.getElementById("commitFee");
const popup = document.getElementById("popup");
const popupMessage = document.getElementById("popupMessage");

function showPopup(msg){
  popupMessage.textContent = msg;
  popup.classList.add("show");
}

function hidePopup(){
  popup.classList.remove("show");
}

function normalizeText() {
  const raw = messageInput.value;
  let lines = [];
  raw.split("\n").forEach(line => {
    while (line.length > MAX_LINE_LENGTH) {
      lines.push(line.slice(0, MAX_LINE_LENGTH));
      line = line.slice(MAX_LINE_LENGTH);
    }
    lines.push(line);
  });

  if (lines.length > MAX_LINES) lines = lines.slice(0, MAX_LINES);
  const finalText = lines.join("\n");

  if (finalText !== messageInput.value) {
    const pos = messageInput.selectionStart;
    messageInput.value = finalText;
    messageInput.selectionStart = messageInput.selectionEnd = pos;
  }

  charCountEl.textContent = finalText.length;
  lineCountEl.textContent = lines.length;

  const canCommit =
    currentAccount &&
    currentChainId === BASE_CHAIN_ID &&
    finalText.length > 0 &&
    finalText.length <= MAX_CHARS &&
    lines.length <= MAX_LINES;

  commitBtn.disabled = !canCommit;
}

messageInput.addEventListener("input", normalizeText);

async function initWeb3() {
  if (!window.ethereum) throw new Error("MetaMask not found");

  const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
  currentAccount = accounts[0];
  walletText.textContent = currentAccount;

  currentChainId = await window.ethereum.request({ method: "eth_chainId" });

  if (currentChainId !== BASE_CHAIN_ID) {
    await window.ethereum.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: BASE_CHAIN_ID }]
    });
    currentChainId = BASE_CHAIN_ID;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  commitFee = await contract.COMMIT_FEE();
  feeEl.textContent = ethers.utils.formatEther(commitFee);

  normalizeText();
}

connectBtn.onclick = async () => {
  try {
    await initWeb3();
    connectBtn.textContent = "Wallet Connected";
    connectBtn.disabled = true;
  } catch (e) {
    showPopup("Wallet connection failed or wrong network");
  }
};

commitBtn.onclick = async () => {
  const message = messageInput.value.trim();
  if (!message) return showPopup("Message is empty");

  commitBtn.classList.add("loading");
  commitBtn.disabled = true;
  statusEl.textContent = "Sending transaction...";

  try {
    const tx = await contract.commit(message, { value: commitFee });
    await tx.wait();
    statusEl.textContent = "✅ Commit successful!";
    messageInput.value = "";
    normalizeText();
  } catch (e) {
    statusEl.textContent = "❌ Commit failed";
  } finally {
    commitBtn.classList.remove("loading");
    commitBtn.disabled = false;
  }
};
</script>

<script>
fetch("/menu.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("global-menu").innerHTML = html;

    const toggle = document.getElementById("menuToggle");
    const menu = document.getElementById("dropdownMenu");

    toggle.addEventListener("click", e => {
      e.stopPropagation();
      menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    });

    document.addEventListener("click", e => {
      if (!menu.contains(e.target) && !toggle.contains(e.target)) {
        menu.style.display = "none";
      }
    });
  });
</script>

</body>
</html>
