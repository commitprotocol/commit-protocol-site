<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mint a Commit — Commit Protocol</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:#0d1117;
  color:#c9d1d9;
  display:flex;
  justify-content:center;
  padding:24px;
}

/* ===== MENU ===== */
.menu-button{
  position:fixed;
  top:16px;
  right:16px;
  background:#161b22;
  border:1px solid #30363d;
  color:#c9d1d9;
  padding:10px 14px;
  border-radius:12px;
  font-size:18px;
  cursor:pointer;
  z-index:9999;
}

.dropdown-menu{
  position:fixed;
  top:56px;
  right:16px;
  background:#161b22;
  border:1px solid #30363d;
  border-radius:12px;
  display:none;
  flex-direction:column;
  padding:10px;
  gap:6px;
  z-index:9998;
}

.dropdown-menu a{
  color:#c9d1d9;
  text-decoration:none;
  padding:8px 14px;
  border-radius:8px;
}
.dropdown-menu a:hover{background:#21262d}

/* ===== PAGE ===== */
main{width:100%;display:flex;justify-content:center}

.card{
  width:100%;
  max-width:520px;
  background:#161b22;
  border:1px solid #30363d;
  border-radius:22px;
  padding:28px;
  text-align:center;
}

textarea{
  width:100%;
  height:420px;
  background:#0d1117;
  border:1px solid #30363d;
  border-radius:12px;
  color:#c9d1d9;
  padding:12px;
  font-family:monospace;
}

#lineInfo{
  font-size:13px;
  opacity:.7;
  text-align:right;
  margin-top:6px;
}

button{
  width:100%;
  padding:14px;
  border-radius:14px;
  font-weight:700;
  margin-top:12px;
  cursor:pointer;
}

button:disabled{opacity:.5;cursor:not-allowed}

#popup{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#161b22;
  border:1px solid #30363d;
  padding:16px 24px;
  border-radius:14px;
  display:none;
  z-index:10000;
}
#popup.show{display:block}
</style>
</head>

<body>

<!-- MENU GLOBAL -->
<button id="menuToggle" class="menu-button">☰</button>
<nav id="dropdownMenu" class="dropdown-menu">
  <a href="index.html">Home</a>
  <a href="commit.html">Commit</a>
  <a href="docs.html">Docs</a>
</nav>

<main>
<article class="card">

<h1>Commit Protocol</h1>
<p style="opacity:.7">Mint an immutable on-chain commit</p>

<textarea id="commitMessage"></textarea>
<div id="lineInfo">
  Lines: <span id="lineCount">0</span> / 21 |
  Chars: <span id="charCount">0</span> / 1049
</div>

<p>COMMIT_FEE: <strong><span id="commitFee">–</span> ETH</strong></p>

<button id="connect">Connect Wallet</button>
<button id="commit" disabled>Commit</button>

<div id="wallet">Wallet not connected</div>
<div id="status"></div>

</article>
</main>

<div id="popup">
  <div id="popupMessage"></div>
  <button onclick="hidePopup()">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
/* ===== MENU ===== */
const menuToggle=document.getElementById("menuToggle");
const dropdownMenu=document.getElementById("dropdownMenu");

menuToggle.onclick=e=>{
  e.stopPropagation();
  dropdownMenu.style.display=
    dropdownMenu.style.display==="flex"?"none":"flex";
};
dropdownMenu.onclick=e=>e.stopPropagation();
document.onclick=()=>dropdownMenu.style.display="none";

/* ===== CONFIG ===== */
const CONTRACT_ADDRESS="0x0b3D715D6EB9e5fd9Da666CB486710A45e8a6895";
const ABI=[
  "function commit(string calldata message) external payable returns(uint256)",
  "function COMMIT_FEE() view returns(uint256)"
];
const BASE_CHAIN_ID="0x2105";
const MAX_LINES=21;
const MAX_CHARS=1049;

/* ===== STATE ===== */
let provider,signer,contract,account,commitFee;

/* ===== DOM ===== */
const msg=document.getElementById("commitMessage");
const charEl=document.getElementById("charCount");
const lineEl=document.getElementById("lineCount");
const commitBtn=document.getElementById("commit");
const connectBtn=document.getElementById("connect");
const walletEl=document.getElementById("wallet");
const statusEl=document.getElementById("status");
const feeEl=document.getElementById("commitFee");
const popup=document.getElementById("popup");
const popupMsg=document.getElementById("popupMessage");

function showPopup(t){popupMsg.textContent=t;popup.classList.add("show")}
function hidePopup(){popup.classList.remove("show")}

/* ===== VALIDATION ===== */
msg.oninput=()=>{
  const lines=msg.value.split("\n").slice(0,MAX_LINES);
  msg.value=lines.join("\n").slice(0,MAX_CHARS);
  charEl.textContent=msg.value.length;
  lineEl.textContent=lines.length;
  commitBtn.disabled=!account||msg.value.length===0;
};

/* ===== WALLET ===== */
async function connect(){
  if(!window.ethereum) return showPopup("Wallet not found");
  [account]=await ethereum.request({method:"eth_requestAccounts"});
  const chainId=await ethereum.request({method:"eth_chainId"});
  if(chainId!==BASE_CHAIN_ID){
    await ethereum.request({
      method:"wallet_switchEthereumChain",
      params:[{chainId:BASE_CHAIN_ID}]
    });
  }
  provider=new ethers.providers.Web3Provider(ethereum);
  signer=provider.getSigner();
  contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
  commitFee=await contract.COMMIT_FEE();
  feeEl.textContent=ethers.utils.formatEther(commitFee);
  walletEl.textContent=account;
  commitBtn.disabled=false;
}

connectBtn.onclick=connect;

/* ===== COMMIT ===== */
commitBtn.onclick=async()=>{
  try{
    statusEl.textContent="Waiting confirmation…";
    const tx=await contract.commit(msg.value,{value:commitFee});
    await tx.wait();
    statusEl.textContent="✅ Commit successful";
    msg.value="";
    msg.oninput();
  }catch(e){
    statusEl.textContent="❌ Commit failed";
  }
};
</script>

</body>
</html>
