<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Commit Protocol — Genesis Commit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
body {
  margin:0;
  min-height:100vh;
  font-family:'Inter', system-ui;
  background:#0d1117;
  color:#c9d1d9;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
}
.card {
  width:100%;
  max-width:500px;
  background:#161b22;
  border-radius:22px;
  padding:28px;
  border:1px solid #30363d;
  box-shadow:0 0 60px rgba(0,0,0,.6);
  text-align:center;
}
.logo { width:72px; margin-bottom:14px; }
h1 { margin:0; font-size:22px; }
.subtitle { font-size:14px; opacity:.8; margin-bottom:18px; color:#8b949e; }
.info { font-size:14px; margin-bottom:10px; }
.wallet { font-size:13px; opacity:.85; margin-bottom:14px; word-break:break-all; color:#8b949e; }

textarea {
  width:100%;
  height:520px;            /* ALTURA FIXA (21 linhas) */
  padding:12px;
  border-radius:12px;
  border:1px solid #30363d;
  background:#0d1117;
  color:#c9d1d9;
  resize:none;
  font-family:JetBrains Mono, monospace;
  font-size:14px;
  line-height:24px;        /* linha bem definida */
  white-space:pre;
  overflow-y:hidden;       /* remove scrollbar */
}

button {
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ccc;
  font-weight:700;
  margin-top:12px;
  cursor:pointer;
  background:#ffffff;
  color:#000;
}
button:disabled { opacity:.45; cursor:not-allowed; }

#lineInfo {
  font-size:13px;
  opacity:.7;
  margin-top:6px;
  text-align:right;
  color:#8b949e;
}

#status { margin-top:14px; min-height:22px; font-size:14px; color:#8b949e; }

#popup {
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#161b22;
  color:#fff;
  padding:16px 24px;
  border-radius:14px;
  border:1px solid #30363d;
  box-shadow:0 10px 40px rgba(0,0,0,.8);
  display:none;
  z-index:1000;
}
#popup.show { display:block; }
#popup button { margin-top:12px; }
</style>
</head>

<body>

<div class="card">
  <img src="logo.png" class="logo">
  <h1>Commit Protocol</h1>
  <div class="subtitle">Make your commit (ASCII art supported)</div>

  <textarea id="commitMessage"
    placeholder="Write your commit message (max 1029 chars, 49 per line)"></textarea>

  <div id="lineInfo">
    Lines: <span id="lineCount">0</span> / 21 |
    Chars: <span id="charCount">0</span> / 1029
  </div>

  <div class="info">
    COMMIT_FEE: <strong><span id="commitFee">–</span> ETH</strong>
  </div>

  <button id="connect">Connect Wallet</button>
  <button id="commit" disabled>Commit</button>

  <div class="wallet" id="wallet">Wallet not connected</div>
  <div id="status"></div>
</div>

<div id="popup">
  <div id="popupMessage"></div>
  <button onclick="hidePopup()">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* ================= CONFIG ================= */

const BASE_CHAIN_ID = "0xaa36a7";
const BASE_CHAIN_DEC = 11155111;

const BASE_CHAIN = {
  chainId: BASE_CHAIN_ID,
  chainName: "Sepolia",
  nativeCurrency: { name:"Ether", symbol:"ETH", decimals:18 },
  rpcUrls: ["https://rpc.sepolia.org"],
  blockExplorerUrls: ["https://sepolia.etherscan.io"]
};

const CONTRACT_ADDRESS = "0x8F8FD7b485971cB402579c3031767f2cA7Ac5a61";

const ABI = [
  "function commit(string calldata message) external payable returns(uint256)",
  "function commitCount() view returns(uint256)",
  "function COMMIT_FEE() view returns(uint256)"
];

const MAX_CHARS = 1029;
const MAX_LINES = 21;
const MAX_LINE_LENGTH = 49;

/* ================= STATE ================= */

let provider, signer, contract, currentAccount;

const connectBtn = document.getElementById("connect");
const commitBtn = document.getElementById("commit");
const walletText = document.getElementById("wallet");
const statusEl = document.getElementById("status");
const messageInput = document.getElementById("commitMessage");
const feeEl = document.getElementById("commitFee");
const popup = document.getElementById("popup");
const popupMessage = document.getElementById("popupMessage");
const charCountEl = document.getElementById("charCount");
const lineCountEl = document.getElementById("lineCount");

/* ================= UI ================= */

function showPopup(msg){
  popupMessage.innerText = msg;
  popup.classList.add("show");
}
function hidePopup(){
  popup.classList.remove("show");
}

/* ====== LINE WRAP FIX (49 chars) ====== */

function updateCounts() {
  const raw = messageInput.value;
  let resultLines = [];

  raw.split("\n").forEach(line => {
    while (line.length > MAX_LINE_LENGTH) {
      resultLines.push(line.slice(0, MAX_LINE_LENGTH));
      line = line.slice(MAX_LINE_LENGTH);
    }
    resultLines.push(line);
  });

  if (resultLines.length > MAX_LINES) {
    resultLines = resultLines.slice(0, MAX_LINES);
  }

  const finalText = resultLines.join("\n");

  if (finalText !== messageInput.value) {
    const cursor = messageInput.selectionStart;
    messageInput.value = finalText;
    messageInput.selectionStart = messageInput.selectionEnd = cursor;
  }

  charCountEl.innerText = finalText.length;
  lineCountEl.innerText = resultLines.length;

  commitBtn.disabled =
    !currentAccount ||
    finalText.length === 0 ||
    finalText.length > MAX_CHARS ||
    resultLines.length > MAX_LINES;
}

messageInput.addEventListener("input", updateCounts);

/* ================= WEB3 ================= */

async function initProvider(){
  provider = new ethers.providers.Web3Provider(window.ethereum,"any");
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  const fee = await contract.COMMIT_FEE();
  feeEl.innerText = ethers.utils.formatEther(fee);
}

async function ensureNetwork(){
  const net = await provider.getNetwork();
  if (net.chainId === BASE_CHAIN_DEC) return;
  await window.ethereum.request({
    method:"wallet_switchEthereumChain",
    params:[{ chainId: BASE_CHAIN_ID }]
  });
}

/* ================= ACTIONS ================= */

connectBtn.onclick = async () => {
  if (!window.ethereum) return showPopup("MetaMask not found");
  const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
  currentAccount = accounts[0];
  await initProvider();
  await ensureNetwork();
  connectBtn.innerText = "Wallet Connected";
  connectBtn.disabled = true;
  walletText.innerText = currentAccount;
  updateCounts();
};

commitBtn.onclick = async () => {
  try {
    await ensureNetwork();
    await initProvider();

    const message = messageInput.value;
    if (!message) return showPopup("Message empty");

    const fee = await contract.COMMIT_FEE();
    statusEl.innerText = "Committing…";

    const tx = await contract.commit(message, { value: fee });
    await tx.wait();

    statusEl.innerHTML =
      `<span style="color:#3fb950">Commit successful</span><br>
       <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">View transaction ↗</a>`;

    messageInput.value = "";
    updateCounts();

  } catch (e) {
    if (e.code === 4001) showPopup("Transaction rejected");
    else showPopup("Commit failed");
  }
};

if (window.ethereum) {
  window.ethereum.on("accountsChanged", () => location.reload());
  window.ethereum.on("chainChanged", () => location.reload());
}
</script>
</body>
</html>
