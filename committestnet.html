<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0x0b3D715D6EB9e5fd9Da666CB486710A45e8a6895"; // Base Mainnet
const ABI = [
  "function commit(string calldata message) external payable returns(uint256)",
  "function COMMIT_FEE() view returns(uint256)"
];

const MAX_LINES = 21;
const MAX_LINE_LENGTH = 49;
const MAX_CHARS = 1049;

/* ================= STATE ================= */
let provider, signer, contract, currentAccount;

const messageInput = document.getElementById("commitMessage");
const charCountEl = document.getElementById("charCount");
const lineCountEl = document.getElementById("lineCount");
const commitBtn = document.getElementById("commit");
const connectBtn = document.getElementById("connect");
const walletText = document.getElementById("wallet");
const statusEl = document.getElementById("status");
const feeEl = document.getElementById("commitFee");
const popup = document.getElementById("popup");
const popupMessage = document.getElementById("popupMessage");

/* ================= UI ================= */
function showPopup(msg){
  popupMessage.innerText = msg;
  popup.classList.add("show");
}
function hidePopup(){
  popup.classList.remove("show");
}

/* ================= TEXT NORMALIZATION ================= */
function normalizeText() {
  const raw = messageInput.value;
  let lines = [];

  raw.split("\n").forEach(line => {
    while (line.length > MAX_LINE_LENGTH) {
      lines.push(line.slice(0, MAX_LINE_LENGTH));
      line = line.slice(MAX_LINE_LENGTH);
    }
    lines.push(line);
  });

  if (lines.length > MAX_LINES) {
    lines = lines.slice(0, MAX_LINES);
  }

  const finalText = lines.join("\n");

  if (finalText !== messageInput.value) {
    const pos = messageInput.selectionStart;
    messageInput.value = finalText;
    messageInput.selectionStart = messageInput.selectionEnd = pos;
  }

  const totalChars = finalText.length;
  charCountEl.innerText = totalChars;
  lineCountEl.innerText = lines.length;

  commitBtn.disabled =
    !currentAccount ||
    totalChars === 0 ||
    totalChars > MAX_CHARS ||
    lines.length > MAX_LINES;
}

messageInput.addEventListener("input", normalizeText);

/* ================= WEB3 ================= */
async function initWeb3() {
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  const fee = await contract.COMMIT_FEE();
  feeEl.innerText = ethers.utils.formatEther(fee);
}

/* ================= ACTIONS ================= */
connectBtn.onclick = async () => {
  if (!window.ethereum) return showPopup("MetaMask not found");

  try {
    const accs = await window.ethereum.request({ method:"eth_requestAccounts" });
    currentAccount = accs[0];
    await initWeb3();
    connectBtn.innerText = "Wallet Connected";
    connectBtn.disabled = true;
    walletText.innerText = currentAccount;
    normalizeText();
  } catch (err) {
    showPopup("Wallet connection failed");
  }
};

commitBtn.onclick = async () => {
  try {
    const message = messageInput.value;
    const fee = await contract.COMMIT_FEE();

    // Verifica saldo antes de enviar a transação
    const balance = await provider.getBalance(currentAccount);
    if (balance.lt(fee)) {
      return showPopup("Insufficient balance to commit");
    }

    statusEl.innerText = "Committing…";
    const tx = await contract.commit(message, { value: fee });
    await tx.wait();
    statusEl.innerHTML = `<span style="color:#3fb950">Commit successful</span>`;
    messageInput.value = "";
    normalizeText();
  } catch (e) {
    if (e.code === 4001) showPopup("Transaction rejected");
    else showPopup("Commit failed");
  }
};
</script>
