<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Commit Protocol — Genesis Mint</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  font-family: 'Inter', system-ui;
  background: #0d1117;
  color: #c9d1d9;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

.card {
  width: 100%;
  max-width: 420px;
  background: #161b22;
  border-radius: 22px;
  padding: 28px;
  border: 1px solid #30363d;
  box-shadow: 0 0 60px rgba(0,0,0,.6);
  text-align: center;
}

.logo { width: 72px; margin-bottom: 14px; }

h1 { margin: 0; font-size: 22px; color: #c9d1d9; }
.subtitle { font-size: 14px; opacity: .8; margin-bottom: 18px; color: #8b949e; }
.info { font-size: 14px; margin-bottom: 10px; color: #c9d1d9; }

.wallet {
  font-size: 13px;
  opacity: .85;
  margin-bottom: 14px;
  word-break: break-all;
  color: #8b949e;
}

.quantity {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin: 16px 0;
  align-items: center;
}

input {
  width: 80px;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #30363d;
  text-align: center;
  font-size: 15px;
  background: #0d1117;
  color: #c9d1d9;
}

button {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: 1px solid #ccc;
  font-weight: 700;
  margin-top: 12px;
  cursor: pointer;
  background: #ffffff;
  color: #000000;
  transition: all 0.2s;
}

button:hover { background: #f0f0f0; }

button.secondary {
  background: #ffffff;
  border: 1px solid #ccc;
  color: #000000;
}

button:disabled { opacity: .45; cursor: not-allowed; }

#status {
  margin-top: 14px;
  min-height: 22px;
  font-size: 14px;
  color: #8b949e;
}

#popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #161b22;
  color: #fff;
  padding: 20px 28px;
  border-radius: 18px;
  border: 1px solid #30363d;
  box-shadow: 0 0 50px rgba(0,0,0,.8);
  display: none;
  z-index: 1000;
  text-align: center;
}

#popup button {
  margin-top: 12px;
  background: #ffffff;
  color: #000;
  border: 1px solid #ccc;
  cursor: pointer;
}

#popup.show { display: block; }
</style>
</head>

<body>
<div class="card">
  <img src="logo.png" class="logo" alt="Commit Protocol">

  <h1>Commit Protocol</h1>
  <div class="subtitle">Genesis Mint Access</div>

  <div class="info">
    Minted: <strong><span id="minted">– / –</span></strong>
  </div>

  <div class="info">
    Time left: <strong><span id="mintTime">–</span></strong>
  </div>

  <div class="quantity">
    <span>Qty</span>
    <input id="qty" type="number" min="1" max="5" value="1">
  </div>

  <div class="info">
    Total: <strong><span id="totalPrice">0.005</span> ETH</strong>
  </div>

  <button id="connect">Connect Wallet</button>
  <button id="mint" disabled>Mint</button>

  <button class="secondary"
    onclick="window.open('https://basescan.org/address/0xc4970B784Bd929F880aE486637d8E5087306dd6a','_blank')">
    View on BaseScan
  </button>

  <div class="wallet" id="wallet">Wallet not connected</div>
  <div id="status"></div>
</div>

<div id="popup">
  <div id="popupMessage"></div>
  <button onclick="hidePopup()">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const connectBtn = document.getElementById("connect");
const mintBtn = document.getElementById("mint");
const walletText = document.getElementById("wallet");
const statusEl = document.getElementById("status");
const qtyInput = document.getElementById("qty");
const totalPriceEl = document.getElementById("totalPrice");
const mintedEl = document.getElementById("minted");
const mintTimeEl = document.getElementById("mintTime");
const popup = document.getElementById("popup");
const popupMessage = document.getElementById("popupMessage");

function showPopup(msg) {
  popupMessage.innerText = msg;
  popup.classList.add("show");
}

function hidePopup() { popup.classList.remove("show"); }

const BASE_CHAIN = {
  chainId: "0x2105",
  chainName: "Base",
  nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
  rpcUrls: ["https://mainnet.base.org"],
  blockExplorerUrls: ["https://basescan.org"]
};

const contractAddress = "0xc4970B784Bd929F880aE486637d8E5087306dd6a";
const abi = [
  "function mint(uint256 amount) public payable",
  "function totalMinted() view returns (uint256)",
  "function MAX_SUPPLY() view returns (uint256)",
  "function mintEnd() view returns (uint256)"
];

const provider = new ethers.providers.Web3Provider(window.ethereum);
const contract = new ethers.Contract(contractAddress, abi, provider);

function updateTotal() {
  const qty = Number(qtyInput.value);
  const price = 0.005;
  totalPriceEl.innerText = (qty * price).toFixed(3);
}
qtyInput.addEventListener("input", updateTotal);

function getContractWithSigner() {
  return contract.connect(provider.getSigner());
}

async function switchNetworkIfNeeded() {
  if (!window.ethereum) return false;

  const network = await provider.getNetwork();
  console.log("Current chainId:", network.chainId);

  if (network.chainId === 8453) return true;

  try {
    await window.ethereum.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x2105" }]
    });
    statusEl.innerText = "Switched to Base network ✅";
    return true;
  } catch (e) {
    if (e.code === 4902) {
      try {
        await window.ethereum.request({ method: "wallet_addEthereumChain", params: [BASE_CHAIN] });
        statusEl.innerText = "Base network added ✅";
        return true;
      } catch (err) {
        showPopup("Failed to add Base network ❌");
        statusEl.innerText = "Failed to add Base network ❌";
        return false;
      }
    } else {
      showPopup("Failed to switch network ❌");
      statusEl.innerText = "Failed to switch network ❌";
      return false;
    }
  }
}

connectBtn.onclick = async () => {
  if (!window.ethereum) {
    showPopup("MetaMask not found! Install MetaMask to connect your wallet.");
    return;
  }

  try {
    statusEl.innerText = "Connecting wallet…";
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    const addr = accounts[0];

    walletText.innerText = addr;

    const networkOk = await switchNetworkIfNeeded();

    if (networkOk) {
      connectBtn.innerText = "Connected";
      connectBtn.disabled = true;
      mintBtn.disabled = false;
      statusEl.innerText = "Wallet connected ✅";
    } else {
      mintBtn.disabled = true;
    }

  } catch (err) {
    console.error(err);
    showPopup("Failed to connect wallet ❌");
    statusEl.innerText = "Failed to connect wallet ❌";
    mintBtn.disabled = true;
  }
};

mintBtn.onclick = async () => {
  if (!window.ethereum) { showPopup("Please install MetaMask"); return; }

  const networkOk = await switchNetworkIfNeeded();
  if (!networkOk) return;

  const qty = Number(qtyInput.value);
  if (qty < 1 || qty > 5) { showPopup("Quantity must be between 1 and 5"); return; }

  try {
    const signerContract = getContractWithSigner();
    const pricePerNFT = ethers.utils.parseEther("0.005");
    const totalPrice = pricePerNFT.mul(qty);

    statusEl.innerText = `Minting ${qty} NFT(s)…`;
    const tx = await signerContract.mint(qty, { value: totalPrice });
    statusEl.innerText = "Transaction sent. Waiting for confirmation…";
    await tx.wait();
    statusEl.innerText = "Mint successful ✅";
    showPopup("Mint successful ✅");
    await updateMinted();
    await updateMintTime();
  } catch (err) {
    console.error(err);
    if (err.code === -32003 || (err.message && err.message.toLowerCase().includes("insufficient funds"))) {
      statusEl.innerText = "Insufficient balance ❌";
      showPopup("Insufficient balance ❌");
    } else {
      statusEl.innerText = "Mint failed ❌";
      showPopup("Mint failed ❌");
    }
  }
};

async function updateMinted() {
  try {
    const network = await provider.getNetwork();
    if (network.chainId !== parseInt(BASE_CHAIN.chainId, 16)) { mintedEl.innerText = "Switch to Base"; return; }
    const c = getContractWithSigner();
    const minted = await c.totalMinted();
    const max = await c.MAX_SUPPLY();
    mintedEl.innerText = `${minted.toString()} / ${max.toString()}`;
  } catch (err) { console.error(err); }
}

async function updateMintTime() {
  try {
    const network = await provider.getNetwork();
    if (network.chainId !== parseInt(BASE_CHAIN.chainId, 16)) { mintTimeEl.innerText = "Switch to Base"; return; }
    const c = getContractWithSigner();
    const endTimestamp = await c.mintEnd();
    const now = Math.floor(Date.now() / 1000);
    let remaining = endTimestamp.toNumber() - now;
    if (remaining <= 0) {
      mintTimeEl.innerText = "Mint ended";
      mintBtn.disabled = true;
      return;
    }
    const hours = Math.floor(remaining / 3600);
    const minutes = Math.floor((remaining % 3600) / 60);
    mintTimeEl.innerText = `${hours}h ${minutes}m`;
  } catch (err) { console.error(err); }
}

setInterval(() => { updateMinted(); updateMintTime(); }, 10000);

updateMinted();
updateMintTime();
updateTotal();
</script>
</body>
</html>
