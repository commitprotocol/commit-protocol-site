<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="/menu.css">
<meta charset="UTF-8">
<title>Mint a Commit - Commit Protocol</title>
<meta name="description" content="Mint an immutable on-chain commit using Commit Protocol. Write ASCII messages and permanently record them on-chain.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }

body {
  margin:0;
  font-family:'Inter', system-ui;
  background:#0d1117;
  color:#c9d1d9;
  display:flex;
  justify-content:center;
  padding:24px;
}

main {
  width:100%;
  display:flex;
  justify-content:center;
}

.card {
  width:100%;
  max-width:520px;
  background:#161b22;
  border-radius:22px;
  padding:28px;
  border:1px solid #30363d;
  box-shadow:0 0 60px rgba(0,0,0,.6);
  text-align:center;
}

.logo { width:72px; margin-bottom:14px; }

h1 { margin:0; font-size:22px; }

.subtitle {
  font-size:14px;
  opacity:.8;
  margin-bottom:18px;
  color:#8b949e;
}

textarea {
  width:100%;
  height:430px;
  padding:12px;
  border-radius:12px;
  border:1px solid #30363d;
  background:#0d1117;
  color:#c9d1d9;
  resize:vertical;
  font-family:JetBrains Mono, monospace;
  font-size:14px;
  line-height:20px;
}

#lineInfo {
  font-size:13px;
  opacity:.7;
  margin-top:6px;
  text-align:right;
  color:#8b949e;
}

.card button {
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #30363d;
  font-weight:700;
  margin-top:12px;
  cursor:pointer;
}

#generatePreview {
  background:#238636;
  color:#fff;
  border:1px solid #2ea043;
}

#commit {
  background:#ffffff;
  color:#000;
}

button:disabled {
  opacity:.45;
  cursor:not-allowed;
}

#wallet, #status {
  font-size:13px;
  margin-top:10px;
  color:#8b949e;
  word-break:break-all;
}

#previewSection {
  display:none;
  margin-top:18px;
}

#previewSection img {
  width:100%;
  border-radius:12px;
  border:1px solid #30363d;
  background:#0d1117;
}

#previewError {
  margin-top:8px;
  font-size:13px;
  color:#ff7b72;
  display:none;
}
</style>
</head>

<body>

<div id="global-menu"></div>

<main>
<article class="card">

<header>
  <img src="logo.png" class="logo">
  <h1>Commit Protocol</h1>
  <div class="subtitle">Preview before mint · irreversible by design</div>
</header>

<section>
  <textarea
    id="commitMessage"
    maxlength="1049"
    placeholder="21 lines · 49 chars per line · total 1049 chars">
  </textarea>

  <div id="lineInfo">
    Lines: <span id="lineCount">0</span> / 21 |
    Chars: <span id="charCount">0</span> / 1049
  </div>
</section>

<button id="generatePreview">Generate Preview</button>

<section id="previewSection">
  <div style="font-size:12px;opacity:.7;margin-bottom:6px;">NFT Preview</div>
  <img id="nftPreview">
  <div id="previewError">Invalid layout. Adjust the text before committing.</div>
</section>

<section>
  <div style="margin-top:12px;font-size:13px;">
    COMMIT_FEE: <strong><span id="commitFee">–</span> ETH</strong>
  </div>
  <button id="connect">Connect Wallet</button>
  <button id="commit" disabled>Commit</button>
  <div id="wallet">Wallet not connected</div>
  <div id="status"></div>
</section>

<footer style="margin-top:18px;font-size:12px;opacity:.6;">
  commit-protocol://v0
</footer>

</article>
</main>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
const CONTRACT_ADDRESS = "0x0b3D715D6EB9e5fd9Da666CB486710A45e8a6895";
const ABI = [
  "function commit(string calldata message) external payable returns(uint256)",
  "function COMMIT_FEE() view returns(uint256)"
];
const BASE_CHAIN_ID = "0x2105";
const MAX_LINES = 21;
const MAX_LINE_LENGTH = 49;
const MAX_CHARS = 1049;

let provider, signer, contract, currentAccount, currentChainId, commitFee;

const messageInput = document.getElementById("commitMessage");
const charCountEl = document.getElementById("charCount");
const lineCountEl = document.getElementById("lineCount");
const commitBtn = document.getElementById("commit");
const connectBtn = document.getElementById("connect");
const previewBtn = document.getElementById("generatePreview");
const previewSection = document.getElementById("previewSection");
const previewImg = document.getElementById("nftPreview");
const previewError = document.getElementById("previewError");
const walletText = document.getElementById("wallet");
const statusEl = document.getElementById("status");
const feeEl = document.getElementById("commitFee");

/* ========= ASCII VALIDATION ========= */

function findInvalidChar(text){
  for(let i=0;i<text.length;i++){
    const code = text.charCodeAt(i);
    const char = text[i];
    if(char === "\n") continue;
    if(code < 0x20 || code > 0x7E){
      return { char, index:i, code };
    }
  }
  return null;
}

function showInvalidCharError(info){
  statusEl.innerHTML = `❌ Invalid character: <strong style="color:#ff7b72;">${info.char}</strong> (U+${info.code.toString(16).toUpperCase().padStart(4,"0")})`;
  statusEl.style.color = "#ff7b72";
  messageInput.focus();
  messageInput.setSelectionRange(info.index, info.index + 1);
}

function clearError(){
  statusEl.textContent = "";
  statusEl.style.color = "#8b949e";
}

/* ========= TEXT NORMALIZATION + HARD LIMIT ========= */

function normalizeText(){
  if(messageInput.value.length > MAX_CHARS){
    messageInput.value = messageInput.value.slice(0, MAX_CHARS);
  }

  const raw = messageInput.value;
  const lines = raw.split("\n");

  charCountEl.textContent = raw.length;
  lineCountEl.textContent = lines.length;

  const invalid = findInvalidChar(raw);
  if(invalid){
    showInvalidCharError(invalid);
    commitBtn.disabled = true;
    return;
  }

  clearError();
}

/* ========= PASTE GUARD ========= */

messageInput.addEventListener("paste", e => {
  const paste = e.clipboardData.getData("text");
  const available = MAX_CHARS - messageInput.value.length;

  if(paste.length > available){
    e.preventDefault();
    messageInput.value += paste.slice(0, available);
  }
});

/* ========= VALIDATION ========= */

function isValidCommit(text){
  const lines = text.split("\n");
  if(lines.length > MAX_LINES) return false;
  for(const l of lines) if(l.length > MAX_LINE_LENGTH) return false;
  return text.length > 0 && text.length <= MAX_CHARS;
}

/* ========= SVG ========= */

function escapeHTML(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function generateSVG(text) {
  const escaped = escapeHTML(text);

  return `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000">
  <rect width="100%" height="100%" fill="#ffffff"/>
  <rect x="60" y="60" width="880" height="880" rx="20"
        fill="#0404e2" stroke="#ffffff" stroke-width="2.5"/>

  <text x="500" y="150" text-anchor="middle"
        style="font-family:JetBrains Mono,monospace;
               font-size:65px;
               fill:#ffffff;
               letter-spacing:1px;">
    COMMIT PROTOCOL
  </text>

  <text x="500" y="200" text-anchor="middle"
        style="font-family:JetBrains Mono,monospace;
               font-size:28px;
               fill:#ffffff;">
    IRREVERSIBLE BY DESIGN
  </text>

  <rect x="120" y="230" width="360" height="50" rx="8"
        fill="#0404e2" stroke="#ffffff" stroke-width="2.5"/>
  <text x="140" y="265"
        style="font-family:monospace;
               font-size:25px;
               fill:#ffffff;">TYPE:</text>
  <text x="219" y="265"
        style="font-family:monospace;
               font-size:30px;
               fill:#ffffff;">IMMUTABLE LOG</text>

  <rect x="510" y="230" width="360" height="50" rx="8"
        fill="#0404e2" stroke="#ffffff" stroke-width="2.5"/>
  <text x="530" y="265"
        style="font-family:monospace;
               font-size:25px;
               fill:#ffffff;">STATUS:</text>
  <text x="639" y="265"
        style="font-family:monospace;
               font-size:30px;
               fill:#ffffff;">COMMITTED</text>

  <rect x="120" y="308" width="760" height="550" rx="12"
        fill="#0404e2" stroke="#ffffff" stroke-width="2.5"/>

  <foreignObject x="145" y="310" width="720" height="560">
    <pre xmlns="http://www.w3.org/1999/xhtml"
         style="font-family:JetBrains Mono,monospace;
                font-size:24px;
                line-height:1;
                color:#ffffff;
                white-space:pre-wrap;">${escaped}</pre>
  </foreignObject>

  <text x="500" y="890" text-anchor="middle"
        style="font-family:JetBrains Mono,monospace;
               font-size:16px;
               fill:#ffffff;">
    initial commit - permanent record - no force push
  </text>

  <text x="500" y="915" text-anchor="middle"
        style="font-family:JetBrains Mono,monospace;
               font-size:16px;
               fill:#ffffff;">
    blockchains never forget
  </text>

  <text x="925" y="925" text-anchor="end"
        style="font-family:JetBrains Mono,monospace;
               font-size:10px;
               fill:#ffffff;">
    commit-protocol://v0
  </text>
</svg>`;
}

/* ========= EVENTS ========= */

messageInput.addEventListener("input", normalizeText);

previewBtn.onclick = () => {
  const text = messageInput.value.trim();
  const invalid = findInvalidChar(text);
  if(invalid) return showInvalidCharError(invalid);

  const valid = isValidCommit(text);
  previewImg.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(generateSVG(text))));
  previewSection.style.display = "block";
  previewError.style.display = valid ? "none" : "block";
  commitBtn.disabled = !(valid && currentAccount && currentChainId === BASE_CHAIN_ID);
};

/* ========= WALLET ========= */

connectBtn.onclick = async () => {
  const accounts = await ethereum.request({ method:"eth_requestAccounts" });
  currentAccount = accounts[0];
  walletText.textContent = currentAccount;

  currentChainId = await ethereum.request({ method:"eth_chainId" });
  if(currentChainId !== BASE_CHAIN_ID)
    await ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:BASE_CHAIN_ID}] });

  provider = new ethers.providers.Web3Provider(ethereum);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  commitFee = await contract.COMMIT_FEE();
  feeEl.textContent = ethers.utils.formatEther(commitFee);

  connectBtn.textContent = "Wallet Connected";
  connectBtn.disabled = true;
};

commitBtn.onclick = async () => {
  statusEl.textContent = "Sending transaction...";
  const tx = await contract.commit(messageInput.value, { value: commitFee });
  await tx.wait();
  statusEl.textContent = "Commit successful";
};
</script>

<script>
fetch("/menu.html")
  .then(r => r.text())
  .then(html => document.getElementById("global-menu").innerHTML = html);
</script>

</body>
</html>
